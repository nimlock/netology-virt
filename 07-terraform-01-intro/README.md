# Домашнее задание к занятию "7.1. Инфраструктура как код"

## Модуль 7. Облачная инфраструктура. Terraform

### Студент: Иван Жиляев

## Задача 1. Выбор инструментов. 
 
### Легенда
 
>Через час совещание на котором менеджер расскажет о новом проекте. Начать работу над которым надо 
>будет уже сегодня. 
>На данный момент известно, что это будет сервис, который ваша компания будет предоставлять внешним заказчикам.
>Первое время, скорее всего, будет один внешних клиент, со временем внешних клиентов станет больше.
>
>Так же по разговорам в компании есть вероятность, что техническое задание еще не четкое, что приведет к большому
>количеству небольших релизов, тестирований интеграций, откатов, доработок, то есть скучно не будет.  
>   
>Вам, как девопс инженеру, будет необходимо принять решение об инструментах для организации инфраструктуры.
>На данный момент в вашей компании уже используются следующие инструменты: 
>- остатки Сloud Formation, 
>- некоторые образы сделаны при помощи Packer,
>- год назад начали активно использовать Terraform, 
>- разработчики привыкли использовать Docker, 
>- уже есть большая база Kubernetes конфигураций, 
>- для автоматизации процессов используется Teamcity, 
>- также есть совсем немного Ansible скриптов, 
>- и ряд bash скриптов для упрощения рутинных задач.  
>
>Для этого в рамках совещания надо будет выяснить подробности о проекте, что бы в итоге определиться с инструментами:
>
>1. Какой тип инфраструктуры будем использовать для этого проекта: изменяемый или не изменяемый?
>1. Будет ли центральный сервер для управления инфраструктурой?
>1. Будут ли агенты на серверах?
>1. Будут ли использованы средства для управления конфигурацией или инициализации ресурсов? 
> 
>В связи с тем, что проект стартует уже сегодня, в рамках совещания надо будет определиться со всеми этими вопросами.

### В результате задачи необходимо

>1. Ответить на четыре вопроса представленных в разделе "Легенда". 
>1. Какие инструменты из уже используемых вы хотели бы использовать для нового проекта? 
>1. Хотите ли рассмотреть возможность внедрения новых инструментов для этого проекта? 
>
>Если для ответа на эти вопросы недостаточно информации, то напишите какие моменты уточните на совещании.

### Решение

Вопросы этой задачи очень тесно связаны друг с другом, можно сказать один вытекает из другого: ответив на четыре вопроса из легенды станет ясно хватит ли уже установленных инструментов или стоит потратить время на разворачивание чего-то более подходящего.

Ответим на вопросы из легенды:

>1. Какой тип инфраструктуры будем использовать для этого проекта: изменяемый или не изменяемый?

- Я считаю, что будет правильно готовить __неизменяемую инфраструктуру__ - это сильно повысит стабильность публикации как тестовых, так и продуктовых версий сервиса. Дополнительно, если продукт планируется передавать внешним заказчикам для установки в их инфраструктуре, то это упростит всем жизнь.

>1. Будет ли центральный сервер для управления инфраструктурой?

- Преимущества использования центрального сервера в данном случае не перекрывают издержек на его сопровождение, так что наша инфраструктура __не будет иметь центрального сервера__. Кроме этого, в стеке имеющихся инструментов все относятся к распределённому типу.

>1. Будут ли агенты на серверах?

- Исходя из используемых инструментов __агенты на серверах нам не потребуются__.

>1. Будут ли использованы средства для управления конфигурацией или инициализации ресурсов?

- Так как планируется масштабировать сервис до больших нагрузок, то стоит сразу ориентироваться на __использование средств управления конфигурацией и/или инициализации ресурсов__ - это позволит в будущем легко производить горизонтальное масштабирование.

Из уже используемых инструментов будем использовать:

- Terraform, как популярное средство инициализации ресурсов.

- Docker, как хорошую основу для неизменяемой инфраструктуры

- Teamcity, для настройки автоматической сборки и публикации релизов продукта

- Ansible, как средство непосредственного конфигурирования сервера

Стоит внедрить следующие новые инструменты:

- git-репозиторий (напр. GitLab, Bitbucket), т.к. планируется большая работа над исходным кодом и git - замечательная практика в этом случае

- хранилище артефактов (напр. JFrog Artifactory, Sonatype Nexus), т.к. при работе с неизменяемой инфраструктурой быстрее и разумнее хранить и запрашивать полученные образы в локальной сети, а не в облачном репозитории.

В целом вижу процесс так: Terraform позволит разворачивать ВМ, проводить базовую конфигурацию (sshd, создание пользователей и т.д.) и устанавливать Docker. Таким образом будет готова основа для запуска контейнеров с собранным кодом. Teamcity позволит автоматизировать тестирование, сборку и доставку нашего сервиса в виде docker-образов на подготовленные ВМ при помощи Ansible.

Если сервис требует запуска и взаимодействия большого количества разных сервисов, то даже для одного клиента уже можно готовить среду на основе Kubernetes, т.е. на совещании стоит выяснить архитектуру сервиса.

## Задача 2. Установка терраформ. 

>Официальный сайт: https://www.terraform.io/
>
>Установите терраформ при помощи менеджера пакетов используемого в вашей операционной системе.
>В виде результата этой задачи приложите вывод команды `terraform --version`.

Для установки воспользовался [руководством для менеджера пакетов apt](https://www.terraform.io/docs/cli/install/apt.html) на сайте Terraform: добавил ключи, репозитории и скачал актуальную версию:

```
ivan@kubang:~/study/netology-virt/07-terraform-01-intro$ terraform --version
Terraform v0.13.5
```

## Задача 3. Поддержка легаси кода. 

>В какой-то момент вы обновили терраформ до новой версии, например с 0.12 до 0.13. 
>А код одного из проектов на столько устарел, что не может работать с версией 0.13. 
>В связи с этим необходимо сделать так, чтобы вы могли одновременно использовать последнюю версию терраформа установленную при помощи
>штатного менеджера пакетов и устаревшую версию 0.12. 
>
>В виде результата этой задачи приложите вывод `--version` двух версий терраформа доступных на вашем компьютере 
>или виртуальной машине.

Для реализации нескольких версий Terraform на хосте разработчик советует использовать подготовленный ими архивы. Так, используем [zip-архив версии 0.12.10](https://releases.hashicorp.com/terraform/0.12.10/terraform_0.12.10_linux_amd64.zip) чтобы скачать legacy-версию приложение. Затем распакуем её и можно пользоваться, запуская соответствующий бинарник. При желании можно сделать симлинки в `PATH` для лёгкой работы c разными версиями ПО, как сделано с pyton2 и pyton3.

```
ivan@kubang:~/study/netology-virt/07-terraform-01-intro$ echo Fresh instance: && terraform --version ; echo Legacy instance: && ./terraform_0.12.10_test --version
Fresh instance:
Terraform v0.13.5
Legacy insstance:
Terraform v0.12.10

Your version of Terraform is out of date! The latest version
is 0.13.5. You can update by downloading from www.terraform.io/downloads.html
```
